# Alembic Database Migration Tutorial

## What is Alembic?

Alembic is a database migration tool for SQLAlchemy that allows you to:
- **Version control your database schema** - Track changes to tables, columns, indexes over time
- **Automatically generate migrations** - Create migration scripts from SQLAlchemy model changes
- **Apply/rollback changes** - Move database forward or backward through migration history
- **Support multiple environments** - Manage different databases for local, dev, and production

## Our Project Setup

Our Alembic configuration supports:
- **Multiple databases**: `equities` and `algorithm` databases
- **Multiple environments**: `local`, `dev`, `prod` configurations
- **Automatic model detection**: Generates migrations from SQLAlchemy table models
- **Thread-safe configuration**: Uses our centralized configuration system

## Directory Structure

```
src/database/
├── migrations/           # Alembic migration files
│   ├── env.py           # Migration environment configuration
│   ├── script.py.mako   # Migration template
│   └── versions/        # Generated migration files (timestamped)
├── tables/              # SQLAlchemy table models
│   └── company.py       # Company table definition
└── base.py             # Database connection and base configuration

alembic.ini             # Alembic configuration file
```

## Prerequisites

### 1. Environment Variables Required

Set these environment variables before running migrations:

```bash
# Required environment variables
ENVIRONMENT=local                                    # or dev, prod
OPTIONS_DEEP_DATA_WAREHOUSE_PASSWORD=your_password  # Database password
```

### 2. Database Must Exist

Ensure the target database exists before running migrations:

```sql
-- For local environment, create these databases:
CREATE DATABASE "equities-local";
CREATE DATABASE "algorithms-local";
```

### 3. Install Dependencies

```bash
pip install -r requirements.txt
# Includes: SQLAlchemy, psycopg2-binary, alembic
```

## Migration Workflow

### Step 1: Check Current Migration Status

```bash
# Check which migrations have been applied
alembic current

# View migration history
alembic history --verbose
```

### Step 2: Generate Migration (After Model Changes)

When you modify SQLAlchemy models in `src/database/tables/`, generate a migration:

```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "Descriptive message about changes"

# Example:
alembic revision --autogenerate -m "Create companies table"
alembic revision --autogenerate -m "Add indexes to companies table"
alembic revision --autogenerate -m "Add stock_prices table"
```

**What this does:**
- Compares current database schema with SQLAlchemy models
- Generates Python migration file in `src/database/migrations/versions/`
- Creates both `upgrade()` and `downgrade()` functions

### Step 3: Review Generated Migration

**Always review the generated migration file** before applying:

```python
# Example generated migration file
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('companies',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('ticker', sa.String(length=20), nullable=False),
    sa.Column('company_name', sa.String(length=500), nullable=False),
    # ... more columns
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_companies_ticker'), 'companies', ['ticker'], unique=True)
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_companies_ticker'), table_name='companies')
    op.drop_table('companies')
    # ### end Alembic commands ###
```

### Step 4: Apply Migration

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific number of migrations
alembic upgrade +1    # Apply next migration
alembic upgrade +2    # Apply next 2 migrations

# Apply to specific migration (using revision ID)
alembic upgrade ae1027a6acf   # Apply to specific revision
```

#### Understanding Revision IDs

**Where revision IDs come from:**
When you generate a migration with `alembic revision --autogenerate`, Alembic creates a unique revision ID (like `ae1027a6acf`) for that migration. This ID is:

1. **Auto-generated**: Created using timestamp and random characters
2. **Unique**: Each migration gets a different ID
3. **Used in filename**: The migration file will be named something like `ae1027a6acf_create_companies_table.py`
4. **Stored in database**: Tracked in the `alembic_version` table

**How to find revision IDs:**

```bash
# View all migration history with revision IDs
alembic history --verbose

# Example output:
# Rev: ae1027a6acf (head)
# Parent: <base>
# Path: /path/to/versions/ae1027a6acf_create_companies_table.py
# 
#     Create companies table
# 
# Rev: b4f2e8c9d12 
# Parent: ae1027a6acf
# Path: /path/to/versions/b4f2e8c9d12_add_stock_prices_table.py
# 
#     Add stock_prices table

# Show just the revision IDs
alembic history

# Example output:
# ae1027a6acf -> b4f2e8c9d12 (head), Add stock_prices table  
# <base> -> ae1027a6acf, Create companies table

# Check current applied revision
alembic current
# Output: ae1027a6acf (head)
```

**Example migration filename and content:**
```
src/database/migrations/versions/ae1027a6acf_create_companies_table.py
```

The file contains:
```python
"""Create companies table

Revision ID: ae1027a6acf
Revises: 
Create Date: 2024-01-15 10:30:45.123456

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'ae1027a6acf'
down_revision = None
branch_labels = None
depends_on = None

def upgrade() -> None:
    # Migration code here
    pass

def downgrade() -> None:
    # Rollback code here
    pass
```

**Using revision IDs in commands:**
```bash
# You can use full or partial revision IDs
alembic upgrade ae1027a6acf        # Full revision ID
alembic upgrade ae1027            # Partial ID (must be unique)
alembic downgrade ae1027a6acf     # Downgrade to specific revision

# Special revision references
alembic upgrade head              # Latest migration
alembic downgrade base            # Back to empty database
alembic upgrade head~1            # One before latest
alembic upgrade head~2            # Two before latest
```

### Step 5: Rollback (if needed)

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific migration (using revision ID from 'alembic history')
alembic downgrade ae1027a6acf

# Rollback to base (empty database)
alembic downgrade base
```

## Database Selection

Our setup supports multiple databases. The default is `equities`:

### Current Configuration
- **Default database**: `equities` (contains companies table)
- **Alternative database**: `algorithm` (for future algorithm data)

To migrate a different database, you would need to modify the configuration in `env.py`.

## Environment-Specific Migrations

### Local Development
```bash
ENVIRONMENT=local alembic upgrade head
```

### Development Environment
```bash
ENVIRONMENT=dev alembic upgrade head
```

### Production Environment
```bash
ENVIRONMENT=prod alembic upgrade head
```

## Common Migration Scenarios

### 1. Creating Your First Migration (Companies Table)

```bash
# 1. Ensure environment variables are set
export ENVIRONMENT=local
export OPTIONS_DEEP_DATA_WAREHOUSE_PASSWORD=postgres

# 2. Generate initial migration
alembic revision --autogenerate -m "Create companies table"

# 3. Apply migration
alembic upgrade head

# 4. Verify table was created
alembic current
```

### 2. Adding New Columns

```python
# 1. Modify your SQLAlchemy model
class Company(Base):
    # ... existing columns
    stock_symbol_type = Column(String(20), nullable=True)  # New column

# 2. Generate migration
alembic revision --autogenerate -m "Add stock_symbol_type to companies"

# 3. Apply migration
alembic upgrade head
```

### 3. Creating New Tables

```python
# 1. Create new SQLAlchemy model in src/database/tables/
class StockPrice(Base):
    __tablename__ = 'stock_prices'
    id = Column(Integer, primary_key=True)
    # ... other columns

# 2. Import in env.py (if not auto-imported)
from src.database.tables.stock_price import StockPrice

# 3. Generate migration
alembic revision --autogenerate -m "Create stock_prices table"

# 4. Apply migration
alembic upgrade head
```

### 4. Dropping Tables/Columns

```bash
# 1. Remove from SQLAlchemy model
# 2. Generate migration
alembic revision --autogenerate -m "Remove deprecated_table"

# 3. Review carefully - dropping data!
# 4. Apply migration
alembic upgrade head
```

## Troubleshooting

### Common Issues

#### 1. "Target database is not up to date"
```bash
# Check current migration status
alembic current

# Apply pending migrations
alembic upgrade head
```

#### 2. "Can't locate revision identified by 'abc123'"
```bash
# Check migration history
alembic history

# Ensure you're in correct environment
echo $ENVIRONMENT
```

#### 3. "No module named 'src.config.database'"
```bash
# Ensure you're in the project root directory
# Check that src/ is in Python path
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
```

#### 4. "Database password environment variable not set"
```bash
# Set required environment variable
export OPTIONS_DEEP_DATA_WAREHOUSE_PASSWORD=your_password
```

#### 5. Migration generates unwanted changes
- Check if models are properly imported in `env.py`
- Verify database connection is correct
- Review model definitions for inconsistencies

### Best Practices

#### 1. Always Review Generated Migrations
- Alembic's auto-generation isn't perfect
- Review for unintended changes
- Test migrations on development data first

#### 2. Use Descriptive Migration Messages
```bash
# Good
alembic revision --autogenerate -m "Add user_preferences table with indexes"

# Bad
alembic revision --autogenerate -m "update stuff"
```

#### 3. Test Rollbacks
```bash
# Test that your migration can be rolled back
alembic upgrade head
alembic downgrade -1
alembic upgrade head
```

#### 4. Backup Before Production Migrations
```bash
# Always backup production database before migrations
pg_dump your_production_db > backup_before_migration.sql
```

#### 5. Migration Naming Convention
- Use descriptive names that explain what changed
- Include table names when relevant
- Use action verbs: "create", "add", "remove", "modify"

## Integration with Our Application

### Adding Database Operations to Company Provider

After migrations create tables, you can add database operations:

```python
# In screener.py or similar data source
def save_to_database(self, companies: List[Company]) -> bool:
    """Save companies to database after fetching from API."""
    with db_connection.session_scope() as session:
        for company_data in companies:
            db_company = Company.from_data_model(company_data)
            session.merge(db_company)  # Insert or update
    return True
```

### Using Migrations in Development Workflow

1. **Make model changes** in `src/database/tables/`
2. **Generate migration** with `alembic revision --autogenerate`
3. **Review migration** file for correctness
4. **Test locally** with `alembic upgrade head`
5. **Commit migration** file to version control
6. **Deploy to dev/prod** environments

## Quick Reference

```bash
# Common Alembic commands
alembic current                    # Show current migration
alembic history                    # Show migration history
alembic upgrade head              # Apply all pending migrations
alembic downgrade -1              # Rollback one migration
alembic revision --autogenerate   # Generate new migration
alembic stamp head                # Mark database as up-to-date without running migrations

# Environment setup
export ENVIRONMENT=local
export OPTIONS_DEEP_DATA_WAREHOUSE_PASSWORD=postgres

# Project-specific
cd /path/to/Options-Deep           # Must be in project root
alembic -c alembic.ini current     # Use specific config file
```

This tutorial covers the complete Alembic workflow for our Options Deep project. Follow these steps to safely manage database schema changes across all environments.